<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Step 4: Emergency Safety - FinCARE</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGeRJkrzIjtM51OFu8_58nAlxAof0QK98",
            authDomain: "fincare-project-4015e.firebaseapp.com",
            databaseURL: "https://fincare-project-4015e-default-rtdb.firebaseio.com",
            projectId: "fincare-project-4015e",
            storageBucket: "fincare-project-4015e.firebasestorage.app",
            messagingSenderId: "415209492661",
            appId: "1:415209492661:web:683ea15a1e177fb4c52efc",
            measurementId: "G-DNG4ZMXG1J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Security Check
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "login.html";
        });

        async function saveEmergencyData() {
            const user = auth.currentUser;
            if (!user) return;

            const nextBtn = document.getElementById('nextBtn');
            nextBtn.innerText = "Processing...";
            nextBtn.style.pointerEvents = "none";

            // Collecting data
            const hasStarted = document.getElementById('emergency-fund-toggle').checked;
            const currentBalance = document.getElementById('emergencyBalance').value;
            const dependents = document.querySelector('input[name="dependents"]:checked')?.id.replace('dep-', '') || "0";
            
            // NEW: Monthly Fix Savings logic
            const fixSavingAmount = document.getElementById('monthlyFixSaving').value;

            const safetyData = {
                safetyNet: {
                    fundStarted: hasStarted,
                    currentBalance: parseFloat(currentBalance) || 0,
                    monthlyFixSaving: parseFloat(fixSavingAmount) || 0, // Saving the new fix amount
                    dependentsCount: dependents,
                    aiRecommendedTarget: 12400 
                },
                currentStep: 4,
                lastUpdated: new Date()
            };

            try {
                const userRef = doc(db, "users", user.uid);
                await updateDoc(userRef, safetyData);
                window.location.href = "step5.html";
            } catch (error) {
                console.error("Error saving safety net:", error);
                alert("Error saving data. Please try again.");
                nextBtn.innerText = "Next";
                nextBtn.style.pointerEvents = "auto";
            }
        }
        window.saveEmergencyData = saveEmergencyData;
    </script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f2cc0d",
                        "background-dark": "#000000",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        :root { --primary: #f2cc0d; }
        .ios-blur { backdrop-filter: blur(20px) saturate(180%); }
        .toggle-checkbox:checked ~ .toggle-container .toggle-track { background-color: var(--primary); }
        .toggle-checkbox:checked ~ .toggle-container .toggle-dot { transform: translateX(24px); }
        .toggle-checkbox:not(:checked) ~ .toggle-container .toggle-track { background-color: #333; }
        .chip-radio:checked + .chip-label { border-color: var(--primary); background: rgba(242,204,13,0.05); color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="font-display text-white overflow-x-hidden antialiased bg-black">
<div class="relative flex min-h-screen w-full flex-col max-w-[430px] mx-auto bg-black overflow-hidden">
    <header class="flex items-center ios-blur bg-black/80 p-4 pb-4 sticky top-0 z-50 border-b border-white/5">
        <a class="text-white flex size-10 items-center justify-center cursor-pointer active:opacity-50" href="step3.html">
            <span class="material-symbols-outlined text-2xl">arrow_back_ios_new</span>
        </a>
        <h2 class="text-white text-base font-bold flex-1 text-center pr-10">Emergency Safety</h2>
    </header>

    <div class="flex flex-col gap-3 p-6 pt-8">
        <div class="flex justify-between items-end">
            <div class="flex flex-col">
                <p class="text-white/40 text-[10px] font-black uppercase tracking-[0.2em]">Step 4 of 7</p>
                <p class="text-white font-bold text-lg">Emergency</p>
            </div>
            <p class="text-primary text-sm font-black">57%</p>
        </div>
        <div class="rounded-full bg-white/5 h-1.5 w-full overflow-hidden border border-white/5">
            <div class="h-full rounded-full bg-primary shadow-[0_0_15px_rgba(242,204,13,0.6)]" style="width: 57%;"></div>
        </div>
    </div>

    <main class="flex-1 px-6 pb-24">
        <section class="mb-8">
            <h1 class="text-white tracking-tight text-3xl font-extrabold leading-tight mb-3">Build your safety net</h1>
            <p class="text-white/50 text-base leading-relaxed">Financial security starts with a buffer.</p>
        </section>

        <div class="flex flex-col gap-6">
            <div class="flex items-center justify-between p-5 rounded-2xl bg-white/[0.03] border border-white/10">
                <div class="flex items-center gap-4">
                    <div class="text-primary flex items-center justify-center rounded-xl bg-primary/10 size-12 border border-primary/20">
                        <span class="material-symbols-outlined fill-1">shield_with_heart</span>
                    </div>
                    <div>
                        <p class="text-white text-base font-bold leading-none">Emergency Fund</p>
                        <p class="text-white/40 text-xs mt-1">Already started?</p>
                    </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer group">
                    <input checked class="sr-only peer toggle-checkbox" id="emergency-fund-toggle" type="checkbox"/>
                    <div class="toggle-container relative">
                        <div class="toggle-track w-14 h-8 rounded-full bg-[#333]">
                            <div class="toggle-dot absolute top-[4px] left-[4px] rounded-full h-6 w-6 bg-white transition-transform duration-300"></div>
                        </div>
                    </div>
                </label>
            </div>

            <div class="flex flex-col gap-2">
                <div class="glass-card rounded-2xl p-5 border-primary/20 bg-primary/5">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="size-10 rounded-xl bg-primary/20 flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary">savings</span>
                        </div>
                        <div>
                            <p class="text-white font-bold text-sm">Monthly Fix Saving</p>
                            <p class="text-white/40 text-[9px] uppercase font-black tracking-widest">Automatic accumulation</p>
                        </div>
                    </div>
                    <div class="relative flex items-center">
                        <span class="absolute left-4 text-primary font-bold">₹</span>
                        <input id="monthlyFixSaving" class="w-full bg-black/40 border border-white/10 focus:border-primary rounded-xl h-14 pl-10 pr-4 text-xl font-black text-white outline-none transition-all" placeholder="0" type="number" value="1000"/>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <label class="flex flex-col w-full">
                    <p class="text-white/50 text-xs font-bold uppercase tracking-widest ml-1 mb-2">Current Balance</p>
                    <div class="relative flex items-center group">
                        <div class="absolute left-4 text-primary transition-transform group-focus-within:scale-110">
                            <span class="material-symbols-outlined text-2xl">account_balance_wallet</span>
                        </div>
                        <input id="emergencyBalance" class="w-full bg-white/[0.03] border border-white/10 focus:border-primary focus:ring-1 focus:ring-primary rounded-2xl h-16 pl-14 pr-16 text-2xl font-black text-white outline-none" placeholder="0.00" type="number" value="5000"/>
                        <div class="absolute right-4 px-3 py-1.5 bg-white/5 rounded-lg text-[10px] font-black text-white/40 border border-white/10">₹</div>
                    </div>
                </label>
            </div>

            <div class="flex flex-col gap-3">
                <p class="text-white/50 text-xs font-bold uppercase tracking-widest ml-1 mb-1">Dependents</p>
                <div class="grid grid-cols-4 gap-3">
                    <div>
                        <input class="sr-only chip-radio" id="dep-0" name="dependents" type="radio"/>
                        <label class="chip-label flex flex-col items-center justify-center h-20 rounded-2xl border border-white/5 bg-white/[0.03] text-white/40 cursor-pointer transition-all" for="dep-0">
                            <span class="text-xl font-extrabold">0</span>
                            <span class="text-[9px] font-black uppercase tracking-tighter">None</span>
                        </label>
                    </div>
                    <div>
                        <input checked class="sr-only chip-radio" id="dep-1" name="dependents" type="radio"/>
                        <label class="chip-label flex flex-col items-center justify-center h-20 rounded-2xl border border-white/5 bg-white/[0.03] text-white/40 cursor-pointer transition-all" for="dep-1">
                            <span class="text-2xl font-black">1</span>
                            <span class="text-[9px] font-black uppercase tracking-tighter">Child</span>
                        </label>
                    </div>
                    <div>
                        <input class="sr-only chip-radio" id="dep-2" name="dependents" type="radio"/>
                        <label class="chip-label flex flex-col items-center justify-center h-20 rounded-2xl border border-white/5 bg-white/[0.03] text-white/40 cursor-pointer transition-all" for="dep-2">
                            <span class="text-xl font-extrabold">2</span>
                            <span class="text-[9px] font-black uppercase tracking-tighter">Family</span>
                        </label>
                    </div>
                    <div>
                        <input class="sr-only chip-radio" id="dep-3" name="dependents" type="radio"/>
                        <label class="chip-label flex flex-col items-center justify-center h-20 rounded-2xl border border-white/5 bg-white/[0.03] text-white/40 cursor-pointer transition-all" for="dep-3">
                            <span class="text-xl font-extrabold">3+</span>
                            <span class="text-[9px] font-black uppercase tracking-tighter">Large</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="relative border border-primary/20 rounded-2xl p-5 flex gap-4 bg-primary/5">
                <div class="text-primary bg-primary/10 border border-primary/20 rounded-full h-10 w-10 flex items-center justify-center shrink-0">
                    <span class="material-symbols-outlined text-xl fill-1">smart_toy</span>
                </div>
                <div class="flex flex-col gap-1">
                    <p class="text-primary text-[10px] font-black uppercase tracking-widest">AI Analysis</p>
                    <p class="text-sm text-white/80 leading-relaxed font-medium">
                        Based on your profile, we recommend a <span class="text-white font-bold">3-month</span> safety net of <span class="text-primary font-black">₹12,400</span>.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[430px] p-6 bg-gradient-to-t from-black via-black/95 to-transparent z-40">
        <button id="nextBtn" onclick="saveEmergencyData()" class="w-full bg-primary hover:brightness-110 active:scale-[0.97] text-black font-black text-lg h-16 rounded-2xl flex items-center justify-center gap-2 transition-all shadow-[0_8px_30px_rgb(242,204,13,0.3)]">
            Next
            <span class="material-symbols-outlined font-black">arrow_forward</span>
        </button>
    </footer>
</div>
</body>
</html>